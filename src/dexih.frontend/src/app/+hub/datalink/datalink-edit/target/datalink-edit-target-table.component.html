<div *ngIf="!showColumn">

<dexih-widget-section title="Edit Target Table" [showExpandButton]="true">
    <ng-template #header>
        <dexih-button-preview class="mr-1" (click)="previewData()"></dexih-button-preview>
        <dexih-button class="mr-1" (click)="importTable()" buttonClass="btn-primary" iconClass="fa fa-refresh" title="Re-import table from connection.">
            Re-Import
        </dexih-button>
        <dexih-button (click)="createTable()" class="mr-1" buttonClass="btn-primary" iconClass="fa fa-bullseye" title="Drop & re-create the table on the connection.  Warning: This remove all data from the table!">
            Drop & Create
        </dexih-button>

        <dexih-button-apply class="mr-1" (click)="apply()" [disabled]="!this.targetTableForm?.dirty"></dexih-button-apply>
        <cancel-button [formsService]="tableFormService"></cancel-button>
    </ng-template>

    <form *ngIf="targetTableForm"  [formGroup]="targetTableForm">
        <fieldset>
            <section>
                <form-checkbox label="Create a new table" [ngModelOptions]="{standalone: true}" [(ngModel)]="newTable" (ngModelChange)="toggleNewTable($event)"></form-checkbox>
            </section>
            <section *ngIf="!newTable">
                <form-select label="Target Table" formControlName="tableKey" [items]="connectionTables" parentName="name" childItems="dexihTables"
                    itemKey="key" itemName="name" note='Select the target table'>
                </form-select>
            </section>
            <section *ngIf="nodes?.length > 0">
                <form-select label="Node level" formControlName="nodeDatalinkColumn" [items]="nodes" [enableKeySelect]="false" itemKey="key" itemName="name" node='Specify the node where the transform should be applied to.' [allowNullSelect]="true" selectNullMessage='Use top level'>
                </form-select>
            </section>
        </fieldset>
    </form>
</dexih-widget-section>

<dexih-table-edit-properties *ngIf="newTable" [formsService]="tableFormService"></dexih-table-edit-properties>

<ng-template [ngIf]="targetTableForm?.controls.table.value">
        <dexih-widget-section title="Columns" [showExpandButton]="true" [padding]="false">
        <dexih-table [enableMultiSelect]="true"
            [enableManualSort]="true" [enableSort]="false" [enableFilter]="false" (onSortChanged)="columnSortChange($event)" [columns]="columns"
            [dataObservable]="tableData" (rowClick)="editColumn($event)">
    
            <ng-template #actions let-items="items">
                <dexih-button-splitdropdown text="Add Column" title="Create a new column" iconClass="fa fa-plus-square" buttonClass="btn-primary"
                    (buttonClick)="newColumn(null)">
                    <li>
                        <a class="dropdown-item" (click)="newColumn(eDeltaType.AutoIncrement)">Add Auto Incrementing Key Column</a>
                    </li>
                    <li>
                        <a class="dropdown-item" (click)="newColumn(eDeltaType.ValidFromDate)">Add Valid from Date</a>
                    </li>
                    <li>
                        <a class="dropdown-item" (click)="newColumn(eDeltaType.ValidToDate)">Add Valid to Date</a>
                    </li>
                    <li>
                        <a class="dropdown-item" (click)="newColumn(eDeltaType.IsCurrentField)">Add Is Current Column</a>
                    </li>
                    <li>
                        <a class="dropdown-item" (click)="newColumn(eDeltaType.CreateAuditKey)">Add Create Audit Key</a>
                    </li>
                    <li>
                        <a class="dropdown-item" (click)="newColumn(eDeltaType.UpdateAuditKey)">Add Update Audit Key</a>
                    </li>
                    <li>
                        <a class="dropdown-item" (click)="newColumn(eDeltaType.CreateDate)">Add Create Date</a>
                    </li>
                    <li>
                        <a class="dropdown-item" (click)="newColumn(eDeltaType.UpdateDate)">Add Update Date</a>
                    </li>
                </dexih-button-splitdropdown>
            </ng-template>
    
            <ng-template #tableHeader let-items="items">
                <column-edit-bulk *ngIf="   showBulkEdit && items.length > 0" [columns]="items" [columnsFormArray]="targetTableForm.controls.table.controls.dexihTableColumns" ></column-edit-bulk>
            </ng-template>

            <ng-template #selectedItemAction select="selectedItemAction" let-column="item">
                <dexih-button-edit (click)="editColumn(column)"></dexih-button-edit>
            </ng-template>
    
            <ng-template #selectedItemsAction select="selectedItemsAction" let-items="items">
                <dexih-button-delete (click)="deleteColumns(items)"></dexih-button-delete>
                <dexih-button class="ml-1" (click)="showBulkEdit=!showBulkEdit">{{showBulkEdit ? 'Hide Bulk Edit' : 'Show Bulk Edit'}} </dexih-button>
            </ng-template>
    
    
        </dexih-table>
        </dexih-widget-section>

        <dexih-widget-section title="Unused Columns" [showExpandButton]="true" [padding]="false">
        <dexih-table [enableMultiSelect]="true"
            sortColumn="position" [enableFilter]="false" [columns]="columns" [dataObservable]="missingColumnsData">
            <ng-template #selectedItemsAction select="selectedItemsAction" let-items="items">
                <dexih-button (click)="addMissing(items)" buttonClass="btn-primary" iconClass="fa fa-plus-square" title="Add selected outputs to the target table">Add To Table</dexih-button>
            </ng-template>
    
        </dexih-table>
        </dexih-widget-section>
    </ng-template>
</div>

<div *ngIf="showColumn">
    <column-edit [columnKey]="columnKey" [tableForm]="this.targetTableForm.controls.table" [deltaType]='deltaType' (isUpdated)="columnUpdated()"></column-edit>
</div>
