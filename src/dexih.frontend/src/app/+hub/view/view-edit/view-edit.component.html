<div class="container" *ngIf="formsService">
	<dexih-widget title="Edit View" iconClass="fa fa-lg fa-fw fa-bar-chart" [showCloseButton]="true" [padding]="false"
	 (close)="close()">
		<ng-template #header>
			<dexih-invalid-form-details [control]="formsService.currentForm" (click)="formsService.showErrors()" class="mr-1"></dexih-invalid-form-details>
			<dexih-button-refresh class="mr-1" (click)="refresh()" text="Reload"></dexih-button-refresh>
			<download-button class="mr-1" (download)="download($event)"></download-button>
			<dexih-button class="mr-1" iconClass="fa fa-line-chart" (click)="showChart = !showChart" [text]="showChart ? 'Show Data' : 'Show Chart'"></dexih-button>
			<save-button *ngIf="hubCache.canWrite" [formsService]="formsService" class="mr-1"></save-button>
			<dexih-button-edit class="mr-1" (click)="showEdit = !showEdit" [text]="showEdit ? 'Hide Edit' : 'Edit'"></dexih-button-edit>
			<cancel-button [formsService]="formsService"></cancel-button>
		</ng-template>

		<dexih-widget-section *ngIf="formsService.currentForm && (showEdit || formsService.currentForm?.controls.parameters.length > 0)" title="Properties" [showExpandButton]="true">
		<form *ngIf="showEdit" [formGroup]="formsService.currentForm">
			<fieldset>
				<section>
					<form-input label="View Name" formControlName="name" placeholder="Enter the view name." [autocapitalize]="on" iconClass="fa fa-list"
					 [errors]="formsService.formErrors['name']">
					</form-input>
				</section>
				<section>
					<form-textarea label="Description" [showMarkdown]="true" formControlName="description" placeholder="Enter the description.">
					</form-textarea>
				</section>
				<section>
					<div class="form-row">
						<section class="form-group col-md-6">
							<form-select label="Data Source Type" formControlName="sourceType" [items]="sourceTypes" itemKey="key" itemName="name"
							 iconClass="fa fa-database" note='Specify the source type for this view' [enableFilter]="false">
							</form-select>
						</section>
						<section class="form-group col-md-6" *ngIf="formsService.currentForm.value.sourceType == eSourceType.Table">
							<form-select label="Source Table" formControlName="sourceTableKey" [errors]="errors?.sourceTableKey" [items]="connectionTables"
							 parentName="name" childItems="dexihTables" itemKey="key" itemName="logicalName" note="Select the source table">
							</form-select>
						</section>
						<section class="form-group col-md-6" *ngIf="formsService.currentForm.value.sourceType == eSourceType.Datalink">
							<form-select label="Source Datalink" formControlName="sourceDatalinkKey" [errors]="errors?.sourceDatalinkKey"
							 [items]="datalinks" itemKey="key" itemName="name" note='Select the source datalink'>
							</form-select>
						</section>
					</div>

					<form-checkbox formControlName="autoRefresh" label="Automatically refresh data when view is opened"></form-checkbox>

				</section>

			</fieldset>
		</form>

		<input-parameters [showEdit]="showEdit" [parameters]="formsService.currentForm?.controls.parameters" [formsService]="formsService"></input-parameters>

		</dexih-widget-section>

		<dexih-widget-section  *ngIf="inputColumns && inputColumns.length > 0" title="InputColumns" [showExpandButton]="true">
			<span *ngFor="let column of inputColumns; let i = index" class="input-group">
				<div class="input-group-prepend">
					<div class="input-group-text">
						{{column.logicalName}}
					</div>
				</div>
				<form-input name="column{{i}}" class="form-control p-0" [placeholder]="'Enter ' + column.logicalName" [(ngModel)]="column.value"></form-input>
			</span>
		</dexih-widget-section>


		<dexih-widget-section  *ngIf="showEdit" title="Query Configuration" [showExpandButton]="true">
			<query-builder  [selectQuery]="formsService.currentForm.controls.selectQuery.value" [columns]="tableColumns" [inputColumns]="inputColumns" [parameters]="formsService.currentForm.controls.parameters.value" (hasChanged)="hasChanged()"></query-builder>
		</dexih-widget-section>

		<ng-template [ngIf]="columns?.length > 0 && data?.length > 0">
			<dexih-table *ngIf="!showChart" [enableMultiSelect]="false" [enableSaveCsv]="true" [columns]="columns" [data]="data" [hideTable]="showChart">
				<!-- <ng-template #actions let-items="items">
					<dexih-button-refresh class="mr-1" (click)="refresh()" text="Reload"></dexih-button-refresh>
				</ng-template> -->
			</dexih-table>

			<div *ngIf="showChart" class="view-height">
			<chart-builder 
				[title]="formsService.currentForm.controls.name.value" 
				[columns]="columns" 
				[data]="data" 
				[config]="formsService.currentForm.controls.chartConfig.value"
				[showEdit]="showEdit"
				(hasChanged)="hasChanged()">
			</chart-builder>
		</div>
		</ng-template>

	</dexih-widget>
</div>