<div class="container">
	<dexih-widget title="Edit View" iconClass="fa fa-lg fa-fw fa-bar-chart" [showCloseButton]="true" [padding]="true"
	 (close)="close()">
		<ng-template #header>
			<dexih-invalid-form-details [control]="formsService.currentForm" (click)="formsService.showErrors()" class="mr-1"></dexih-invalid-form-details>
			<dexih-button-refresh class="mr-1" (click)="refresh()" text="Reload"></dexih-button-refresh>
			<download-button class="mr-1" (download)="download($event)"></download-button>
			<dexih-button class="mr-1" iconClass="fa fa-line-chart" (click)="showChart = !showChart" [text]="showChart ? 'Show Data' : 'Show Chart'"></dexih-button>
			<dexih-button-save class="mr-1" (click)="save()"></dexih-button-save>
			<dexih-button-edit class="mr-1" (click)="showEdit = !showEdit" [text]="showEdit ? 'Hide Edit' : 'Edit'"></dexih-button-edit>
			<cancel-button [formsService]="formsService"></cancel-button>
		</ng-template>

		<form *ngIf="formsService.currentForm && showEdit" [formGroup]="formsService.currentForm">
			<fieldset>
				<section>
					<form-input label="View Name" formControlName="name" placeholder="Enter the view name." [autocapitalize]="on" iconClass="fa fa-list"
					 [errors]="formsService.formErrors['name']">
					</form-input>
				</section>
				<section>
					<form-textarea label="Description" [showMarkdown]="true" formControlName="description" placeholder="Enter the description.">
					</form-textarea>
				</section>
				<section>
					<div class="form-row">
						<section class="form-group col-md-6">
							<form-select label="Data Source Type" formControlName="sourceType" [items]="sourceTypes" itemKey="key" itemName="name"
							 iconClass="fa fa-database" note='Specify the source type for this view' [enableFilter]="false">
							</form-select>
						</section>
						<section class="form-group col-md-6" *ngIf="formsService.currentForm.value.sourceType == eSourceType.Table">
							<form-select label="Source Table" formControlName="sourceTableKey" [errors]="errors?.sourceTableKey" [items]="connectionTables"
							 parentName="name" childItems="dexihTables" itemKey="key" itemName="logicalName" note="Select the source table">
							</form-select>
						</section>
						<section class="form-group col-md-6" *ngIf="formsService.currentForm.value.sourceType == eSourceType.Datalink">
							<form-select label="Source Datalink" formControlName="sourceDatalinkKey" [errors]="errors?.sourceDatalinkKey"
							 [items]="datalinks" itemKey="key" itemName="name" note='Select the source datalink'>
							</form-select>
						</section>
					</div>

				</section>

			</fieldset>
		</form>

		<div class="d-flex flex-wrap pt-1" *ngIf="inputColumns && inputColumns.length > 0" >
			<span *ngFor="let column of inputColumns; let i = index" class="input-group">
				<div class="input-group-prepend">
					<div class="input-group-text">
						{{column.logicalName}}
					</div>
				</div>
				<form-input name="column{{i}}" class="form-control p-0" [placeholder]="'Enter ' + column.logicalName" [(ngModel)]="column.value"></form-input>
			</span>
		</div>

		<section *ngIf="showEdit">
			<h5>Data Configuration</h5>
			<query-builder  [selectQuery]="selectQuery" [columns]="tableColumns" [inputColumns]="inputColumns"></query-builder>
		</section>

		<ng-template [ngIf]="columns?.length > 0 && data?.length > 0">
			<dexih-table [enableMultiSelect]="false" [enableSaveCsv]="true" [columns]="columns" [data]="data" [hideTable]="showChart">
				<!-- <ng-template #actions let-items="items">
					<dexih-button-refresh class="mr-1" (click)="refresh()" text="Reload"></dexih-button-refresh>
				</ng-template> -->
			</dexih-table>

			<section *ngIf="showChart" [ngStyle]="{'display': showChart ? 'block' : 'none' }" class="mt-1">
				<h5 *ngIf="showEdit">Chart Configuration</h5>
				<chart-builder [title]="formsService.currentForm.controls.name.value" [columns]="columns" [data]="data" [config]="chartConfig"
				 [showEdit]="showEdit"></chart-builder>
			</section>
		</ng-template>

	</dexih-widget>